# NCCN指南下载工具 v2.0 使用说明

## 概述

NCCN指南下载工具v2.0是一个优化的菜单式下载工具，支持多主题分类下载、安全请求控制、完善日志和重新下载功能。相比原版脚本，v2.0版本提供了更好的用户体验和更强大的功能。

## 主要特性

### 🎯 核心功能
- **菜单式操作**: 交互式界面，无需修改代码
- **多主题支持**: 5种不同类型的NCCN指南
- **双重认证**: 用户名密码 + Cookie认证
- **智能重试**: 失败文件自动重新下载
- **增量下载**: 避免重复下载已有文件
- **完善日志**: 详细操作记录和统计报告

### 🔒 安全性
- **请求频率控制**: 2-5秒随机延迟
- **错误重试机制**: 最多3次重试
- **会话状态管理**: 自动检测和重新认证
- **文件完整性验证**: PDF文件头和大小检查

### 📊 统计和监控
- **实时进度显示**: 下载进度条
- **详细统计报告**: 成功率、速度、耗时等
- **失败文件清单**: 失败文件列表和重试选项
- **日志文件**: 完整的操作记录

## 安装依赖

确保已安装所需的Python包:

```bash
pip install requests beautifulsoup4 tqdm
```

如果`tqdm`未安装，工具会自动降级到简单进度显示。

## 使用方法

### 1. 运行程序

```bash
python download_NCCN_Guide_v2_menu.py
```

### 2. 选择认证方式

程序启动后会提示选择认证方式:

```
请选择认证方式:
1. 用户名/密码登录
2. Cookie登录
```

#### 方式1: 用户名/密码登录
- 输入您的NCCN账户邮箱
- 输入密码
- 程序会自动登录并验证

#### 方式2: Cookie登录
- 选择从环境变量读取或手动输入
- 如果选择环境变量，需要设置:
  ```bash
  export NCCN_COOKIE="your_cookie_string_here"
  ```
- 或者直接粘贴Cookie字符串

### 3. 选择下载主题

认证成功后，显示主菜单:

```
主菜单 - 请选择要下载的主题:
==========================================
1. 癌症治疗指南 (Treatment by Cancer Type)
   按癌症类型分类的治疗指南
   目录: 01_Cancer_Treatment

2. 支持性护理指南 (Supportive Care)
   支持性护理相关指南
   目录: 02_Supportive_Care

3. 患者指南 (Patient Guidelines)
   患者专用指南
   目录: 03_Patient_Guidelines

4. 临床指南中文翻译 (Clinical Translations)
   临床指南中文翻译版本
   目录: 04_Clinical_Translations

5. 患者指南中文翻译 (Patient Guidelines Translations)
   患者指南中文翻译版本
   目录: 05_Patient_Translations

6. 查看下载统计
7. 退出
```

### 4. 下载过程

选择主题后，程序会:
1. 自动创建对应的目录结构
2. 解析网页获取PDF链接
3. 显示下载进度
4. 验证文件完整性
5. 生成下载统计报告

### 5. 处理失败下载

如果某些文件下载失败，程序会:
1. 显示失败文件清单
2. 询问是否重新下载
3. 重新尝试下载失败的文件

## 目录结构

下载的文件将按以下结构组织:

```
nccn_downloads/
├── 01_Cancer_Treatment/          # 癌症治疗指南
│   ├── Breast_Cancer_Latest.pdf
│   ├── Lung_Cancer_Latest.pdf
│   └── ...
├── 02_Supportive_Care/           # 支持性护理指南
│   ├── Palliative_Care_Latest.pdf
│   └── ...
├── 03_Patient_Guidelines/        # 患者指南
│   ├── Breast_Cancer_Patients_Latest.pdf
│   └── ...
├── 04_Clinical_Translations/     # 临床指南中文翻译
│   └── Chinese_Clinical_Guidelines.pdf
├── 05_Patient_Translations/      # 患者指南中文翻译
│   └── Chinese_Patient_Guidelines.pdf
└── logs/                        # 日志文件
    ├── download_20241201.log
    └── stats_cancer_treatment_20241201_143022.json
```

## 日志和统计

### 日志文件
- **download_YYYYMMDD.log**: 详细的操作日志
- **stats_THEME_YYYYMMDD_HHMMSS.json**: 下载统计数据

### 统计信息
程序会显示以下统计信息:
- 总文件数
- 成功下载数
- 跳过文件数(已存在)
- 下载失败数
- 成功率
- 总耗时
- 平均下载速度
- 下载数据量

## 配置选项

### 环境变量
- `NCCN_COOKIE`: 用于Cookie认证的Cookie字符串

### 编程配置
可以在代码中修改以下参数:
- `max_retries`: 最大重试次数 (默认3)
- `retry_delay`: 重试间隔 (默认5秒)
- `request_delay`: 请求延迟范围 (默认2-5秒)
- `min_file_size`: 最小文件大小 (默认100KB)

## 错误处理

### 常见问题
1. **认证失败**
   - 检查用户名密码是否正确
   - 确认Cookie是否有效
   - 尝试重新获取Cookie

2. **下载失败**
   - 检查网络连接
   - 确认NCCN网站是否可访问
   - 程序会自动重试

3. **文件验证失败**
   - 程序会跳过无效文件
   - 检查文件大小是否正常

### 日志调试
查看日志文件获取详细错误信息:
```bash
tail -f nccn_downloads/logs/download_$(date +%Y%m%d).log
```

## 最佳实践

### 1. 首次使用
- 先尝试下载一个小主题测试
- 确认认证方式工作正常
- 查看日志确保没有错误

### 2. 定期更新
- 定期重新下载以获取最新版本
- 使用增量下载避免重复下载
- 备份重要的指南文件

### 3. 批量下载
- 可以逐个下载不同主题
- 程序会自动管理目录结构
- 查看统计了解下载状态

### 4. 错误恢复
- 关注失败文件列表
- 及时重新下载失败的文件
- 检查日志了解失败原因

## 版本更新

### v2.0.0 更新内容
- ✅ 新增菜单式操作界面
- ✅ 支持5种不同主题下载
- ✅ 双重认证方式(用户名密码+Cookie)
- ✅ 智能目录管理和增量下载
- ✅ 请求频率控制和错误重试
- ✅ 完善的日志和统计系统
- ✅ 失败文件自动重新下载
- ✅ 文件完整性验证
- ✅ 实时进度显示

### 与原版对比
| 功能 | 原版 | v2.0 |
|------|------|------|
| 操作方式 | 硬编码URL | 菜单选择 |
| 主题支持 | 单一主题 | 5种主题 |
| 认证方式 | 仅用户名密码 | 双认证方式 |
| 目录管理 | 单一目录 | 分类目录 |
| 增量下载 | 无 | 智能检测 |
| 错误重试 | 无 | 自动重试 |
| 日志系统 | 基础日志 | 完善统计 |
| 失败恢复 | 手动处理 | 自动处理 |

## 技术支持

### 获取帮助
- 查看日志文件获取详细错误信息
- 确认网络连接和认证信息
- 验证NCCN网站可访问性

### 报告问题
请提供以下信息:
- 操作系统和Python版本
- 完整的错误日志
- 认证方式和使用步骤
- NCCN网站访问状态

## 许可证

本工具仅供学习和研究使用，请遵守NCCN网站的使用条款。

---

**感谢使用NCCN指南下载工具v2.0!**
感谢小x宝社区志愿者用❤️发电。