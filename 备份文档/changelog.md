# NCCN指南下载工具更新日志

## [v2.0.0] - 2024-12-01

### 🚀 重大更新

#### 新增功能
- **菜单式操作界面**: 完全重新设计的交互式菜单系统
- **多主题支持**: 新增5种不同类型的NCCN指南下载支持
- **双重认证方式**: 支持用户名/密码登录和Cookie认证
- **智能目录管理**: 自动创建主题分类目录结构
- **增量下载机制**: 智能检测已存在文件，避免重复下载
- **完善日志系统**: 分级日志记录、统计报告生成
- **失败文件重新下载**: 自动识别失败文件并提供重新下载选项

#### 安全性改进
- **请求频率控制**: 实现2-5秒随机延迟，防止请求过快
- **错误重试机制**: 最多3次重试，智能等待策略
- **会话状态管理**: 自动检测登录状态并重新认证
- **文件完整性验证**: PDF文件头检查和大小验证

#### 用户体验优化
- **实时进度显示**: 使用tqdm显示下载进度
- **详细统计报告**: 下载成功率、速度、耗时等统计信息
- **友好错误提示**: 清晰的错误信息和解决建议
- **中断恢复支持**: 支持Ctrl+C中断并恢复操作

#### 目录结构优化
```
nccn_downloads/
├── 01_Cancer_Treatment/          # 新增
├── 02_Supportive_Care/           # 新增
├── 03_Patient_Guidelines/        # 新增
├── 04_Clinical_Translations/     # 新增
├── 05_Patient_Translations/      # 新增
└── logs/                        # 增强
```

### 📊 支持的下载主题

1. **癌症治疗指南** (Treatment by Cancer Type)
   - URL: `https://www.nccn.org/guidelines/category_1`
   - 功能: 按癌症类型分类的治疗指南

2. **支持性护理指南** (Supportive Care)
   - URL: `https://www.nccn.org/guidelines/category_3`
   - 功能: 支持性护理相关指南

3. **患者指南** (Patient Guidelines)
   - URL: `https://www.nccn.org/patientresources/patient-resources/guidelines-for-patients`
   - 功能: 患者专用指南

4. **临床指南中文翻译** (Clinical Translations)
   - URL: `https://www.nccn.org/global/what-we-do/clinical-guidelines-translations`
   - 功能: 临床指南中文翻译版本

5. **患者指南中文翻译** (Patient Guidelines Translations)
   - URL: `https://www.nccn.org/global/what-we-do/guidelines-for-patients-translations`
   - 功能: 患者指南中文翻译版本

### 🔧 技术改进

#### 代码架构
- **面向对象设计**: 重新设计为完整的类结构
- **类型注解**: 添加完整的类型提示
- **数据类**: 使用@dataclass管理配置和统计数据
- **异常处理**: 完善的多层异常处理机制

#### 网络请求优化
- **会话管理**: 使用requests.Session提高性能
- **请求头优化**: 更真实的浏览器请求头
- **超时设置**: 合理的连接和读取超时
- **流式下载**: 支持大文件的流式下载

#### 文件处理改进
- **临时文件机制**: 下载时使用临时文件，避免不完整文件
- **文件验证**: 多层次的PDF文件有效性检查
- **文件名清理**: 智能清理不安全的文件名字符
- **重复检测**: 避免重复下载相同文件

### 📝 配置和日志

#### 新增配置选项
- `max_retries`: 最大重试次数 (默认3)
- `retry_delay`: 重试间隔 (默认5秒)
- `request_delay`: 请求延迟范围 (默认2-5秒)
- `min_file_size`: 最小文件大小 (默认100KB)

#### 日志增强
- **结构化日志**: 按日期分组的日志文件
- **统计报告**: JSON格式的详细统计报告
- **错误追踪**: 完整的错误堆栈和重试记录
- **性能监控**: 下载速度和响应时间统计

### 🔄 与原版对比

| 功能特性 | 原版脚本 | v2.0.0 |
|---------|---------|--------|
| 操作方式 | 硬编码配置 | 交互式菜单 |
| 主题支持 | 单一主题 | 5种主题 |
| 认证方式 | 仅用户名密码 | 双重认证 |
| 目录管理 | 单一目录 | 分类目录 |
| 增量下载 | 基础检查 | 智能检测 |
| 错误处理 | 简单重试 | 智能重试 |
| 日志系统 | 基础日志 | 完善统计 |
| 用户界面 | 命令行 | 菜单交互 |
| 失败恢复 | 手动处理 | 自动处理 |
| 进度显示 | 基础显示 | 详细进度 |
| 文件验证 | 基础检查 | 多层验证 |

### 🐛 问题修复

1. **登录验证问题**: 修复了某些情况下的登录状态检测
2. **文件重复下载**: 实现了更准确的重复文件检测
3. **网络超时处理**: 优化了网络请求的超时和重试机制
4. **内存使用优化**: 改进了大文件下载的内存使用
5. **编码问题**: 修复了中文字符的编码处理

### 📋 依赖更新

#### 新增依赖
- `tqdm`: 用于进度条显示 (可选，无依赖时自动降级)

#### 保持兼容
- `requests`: HTTP请求库
- `beautifulsoup4`: HTML解析
- `pathlib`: 路径管理 (Python 3.4+)
- `dataclasses`: 数据类 (Python 3.7+)

### 📖 文档更新

- **使用说明**: 全新的README_v2.md用户指南
- **配置文档**: 新增config.json配置模板
- **开发计划**: 新增plan.md开发计划文档
- **更新日志**: 新增changelog.md版本记录

---

## 升级指南

### 从原版升级到v2.0

1. **备份数据**: 备份现有的下载文件和配置
2. **安装依赖**: 确保安装所需的Python包
3. **更新脚本**: 使用新的download_NCCN_Guide_v2_menu.py
4. **重新配置**: 根据新的菜单界面重新设置参数
5. **测试运行**: 先测试一个小主题下载

### 配置迁移

原版的硬编码配置不再适用，v2.0使用交互式菜单配置。如需持久化配置，可以:
- 使用环境变量 `NCCN_COOKIE` 进行Cookie认证
- 修改config.json调整默认参数

---

**感谢使用NCCN指南下载工具v2.0！**

如有问题或建议，请查看README_v2.md获取详细使用说明。